┌──────────────────────────────────────────┐
│ Step 1: RawSample → HrSample             │
│                                          │
│ t0 = first.timestamp                      │
│ timeSeconds = (ts - t0) / 1000           │
│ hr = sample.x                            │
│                                          │
│ Output:                                  │
│ HrSample(timeSeconds, hr)                │
└─────────────┬────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────┐
│ Step 2: HR Resampling (1 Hz)             │
│                                          │
│ - Remove duplicates                      │
│ - Sort by time                           │
│ - Interpolate missing seconds            │
│                                          │
│ Output:                                  │
│ List<HrSample> (uniform 1s grid)         │
└─────────────┬────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────┐
│ Step 3: Dynamic HRmax Tracking           │
│                                          │
│ - Track candidate HR > HRmax             │
│ - Require +Δ BPM (noise guard)           │
│ - Sustain for 5 consecutive seconds      │
│                                          │
│ Output (per sample):                     │
│ currentHrMax                             │
└─────────────┬────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────┐
│ Step 4: Per-Second HR Timeline           │
│                                          │
│ For each HrSample:                       │
│ - Resolve HR zone                        │
│ - Compute TRIMP increment                │
│ - Attach dynamic HRmax                   │
│                                          │
│ Output:                                  │
│ HrTimelinePoint {                        │
│   timeSeconds                            │
│   hr                                     │
│   zone                                   │
│   trimp                                  │
│   hrMax                                  │
│ }                                        │
└─────────────┬────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────┐
│ Step 5: Effort Detection                 │
│                                          │
│ - Detect sustained high-HR segments      │
│ - Threshold based on HRmax               │
│                                          │
│ Output:                                  │
│ List<EffortSegment>                      │
└─────────────┬────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────┐
│ Step 6: HR Recovery (HRR)                │
│                                          │
│ - Extract post-effort window             │
│ - Compute HR drop metrics                │
│                                          │
│ Output:                                  │
│ List<HrrResult>                          │
└─────────────┬────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────┐
│ Step 7: Training Load (TRIMP)            │
│                                          │
│ - Edwards TRIMP (zones)                  │
│ - Banister TRIMP (HRR-based)             │
│                                          │
│ Output:                                  │
│ TrimpSummary                             │
└─────────────┬────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────┐
│ Step 8: Time in HR Zones                 │
│                                          │
│ - Aggregate seconds per zone             │
│ - Build zone summary                     │
│                                          │
│ Output:                                  │
│ TimeInZoneSummary                        │
└─────────────┬────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────┐
│ Step 9: VO₂max Estimation                │
│                                          │
│ - Use HR dynamics + intensity            │
│ - Optional (null if not enough data)     │
│                                          │
│ Output:                                  │
│ Vo2MaxSummary?                           │
└─────────────┬────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────┐
│ Final Output: HrResult                   │
│                                          │
│ - samples                                │
│ - timeline                               │
│ - efforts                                │
│ - recoveries                             │
│ - trimp                                  │
│ - zones                                  │
│ - vo2max                                 │
│ - hasNewHrMax                            │
│ - updatedHrMax                           │
└──────────────────────────────────────────┘
